name: Deploy bot to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH key for EC2
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Clean and prepare remote folder
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é..."
          rm -rf ~/tutor_bot
          mkdir -p ~/tutor_bot
        EOF

    - name: Upload project to EC2
      run: |
        echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        scp -r . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/tutor_bot

    - name: Setup, install, and restart bot
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          set -e

          echo "üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"
          cd ~/tutor_bot

          echo "üìÅ –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É logs –∏ –¥–∞—ë–º –ø—Ä–∞–≤–∞"
          mkdir -p logs
          chmod 777 logs

          echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Poetry (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)"
          curl -sSL https://install.python-poetry.org | python3 - || true
          export PATH="\$HOME/.local/bin:\$PATH"

          echo "üìú –°–æ–∑–¥–∞—ë–º creds.ini –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞"
          echo "${{ secrets.CREDS_INI_CONTENT }}" > creds.ini

          echo "üìú –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è systemd"
          echo "MONGO_HOST=${{ secrets.MONGO_HOST }}" | sudo tee /etc/default/tutor_bot > /dev/null
          echo "MONGO_PORT=${{ secrets.MONGO_PORT }}" | sudo tee -a /etc/default/tutor_bot > /dev/null
          echo "MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}" | sudo tee -a /etc/default/tutor_bot > /dev/null
          echo "MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}" | sudo tee -a /etc/default/tutor_bot > /dev/null
          sudo chmod 644 /etc/default/tutor_bot

          echo "üì¶ –£–¥–∞–ª—è–µ–º poetry.lock –∏ –æ–±–Ω–æ–≤–ª—è–µ–º git-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
          rm -f poetry.lock
          poetry update kosokolovsky-telegram-bot connectors --no-interaction

          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
          poetry install --no-interaction

          echo "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ systemd-—Å–µ—Ä–≤–∏—Å–∞"
          sudo systemctl daemon-reexec
          sudo systemctl daemon-reload
          sudo systemctl restart tutor_bot

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
        EOF
