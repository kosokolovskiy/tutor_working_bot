name: Deploy bot to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up SSH key for EC2
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Clean and prepare remote folder
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "ðŸ§¹ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²ÑƒÑŽ..."
          rm -rf ~/tutor_bot
          mkdir -p ~/tutor_bot
        EOF

    - name: Upload project to EC2
      run: |
        echo "ðŸ“¦ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
        scp -r . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/tutor_bot

    - name: Install Poetry, inject creds, configure systemd env, restart service
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          set -e

          echo "ðŸš€ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
          cd ~/tutor_bot

          echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ logs Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°"
          mkdir -p logs
          chmod 777 logs

          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Poetry, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾"
          curl -sSL https://install.python-poetry.org | python3 - || true
          export PATH="\$HOME/.local/bin:\$PATH"

          echo "ðŸ“œ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ creds.ini Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð°"
          echo "${{ secrets.CREDS_INI_CONTENT }}" > creds.ini

          echo "ðŸ› ï¸ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ systemd"
          sudo tee /etc/default/tutor_bot > /dev/null <<EOT
MONGO_HOST=${{ secrets.MONGO_HOST }}
MONGO_PORT=${{ secrets.MONGO_PORT }}
MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}
MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
EOT

          echo "ðŸ“¦ Ð£Ð´Ð°Ð»ÑÐµÐ¼ poetry.lock Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ git-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸"
          rm -f poetry.lock

          echo "ðŸ”„ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ git-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸"
          poetry update kosokolovsky-telegram-bot connectors --no-interaction

          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
          poetry install --no-interaction

          echo "ðŸ” ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº systemd-ÑÐµÑ€Ð²Ð¸ÑÐ°"
          sudo systemctl daemon-reexec
          sudo systemctl daemon-reload
          sudo systemctl restart tutor_bot

          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
        EOF
